WITH fundamentals AS (
    SELECT
        TICKER,
        NAME,
        ASSETTYPE,
        DESCRIPTION,
        CIK,
        EXCHANGE,
        CURRENCY,
        COUNTRY,
        SECTOR,
        INDUSTRY,
        ADDRESS,
        FISCALYEAREND,
        LATESTQUARTER,
        MARKETCAPITALIZATION,
        EBITDA,
        PERATIO,
        PEGRATIO,
        BOOKVALUE,
        DIVIDENDPERSHARE,
        DIVIDENDYIELD,
        EPS,
        REVENUEPERSHARETTM,
        PROFITMARGIN,
        OPERATINGMARGINTTM,
        RETURNONASSETS,
        RETURNONEQUITY,
        REVENUETTM,
        GROSSPROFITTTM,
        DILUTEDEPSTTM,
        QUARTERLYEARNINGSGROWTHYOY,
        QUARTERLYREVENUEGROWTHYOY,
        ANALYSTTARGETPRICE,
        TRAILINGPE,
        FORWARDPE,
        PRICETOSALESTTM,
        PRICETOBOOKRATIO,
        EVTOREVENUE,
        EVTOEBITDA,
        BETA,
        WEEK52HIGH,
        WEEK52LOW,
        DAY50MOVINGAVERAGE,
        DAY200MOVINGAVERAGE,
        SHARESOUTSTANDING,
        DIVIDENDDATE,
        EXDIVIDENDDATE,
        SOURCE_FILE,
        LOAD_TIME            -- ðŸ‘ˆ FIXED
    FROM {{ ref('stg_stockoverview') }}
),

latest_price AS (
    SELECT
        STOCK_TICKER AS TICKER,
        CLOSE_PRICE,
        TRADING_VOLUME,
        TRADING_DATE
    FROM {{ ref('stg_stockpricedata') }}
    QUALIFY ROW_NUMBER() OVER (
        PARTITION BY STOCK_TICKER ORDER BY TRADING_DATE DESC
    ) = 1
)

SELECT
    f.*,
    lp.CLOSE_PRICE     AS LATEST_CLOSE_PRICE,
    lp.TRADING_VOLUME  AS LATEST_VOLUME,
    lp.TRADING_DATE    AS LATEST_PRICE_DATE
FROM fundamentals f
LEFT JOIN latest_price lp
    ON f.TICKER = lp.TICKER